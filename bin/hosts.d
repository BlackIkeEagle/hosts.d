#!/usr/bin/env sh
# vim: ft=sh:

set -x

HOSTS="/etc/hosts"
HOSTSD="/etc/hosts.d"

usage() {
    echo "usage"
}

check_configfile() {
    local configfile="$1"
    local tmphostsd=''

    if [ "$configfile" = "" ]; then
        echo ""
        return 0
    fi

    configfile=$(realpath $configfile)

    if [ ! -e "$configfile" ]; then
        echo "config $configfile does not exist"
        return 1
    else
        if ! grep -e 'HOSTS=' $configfile > /dev/null 2>&1; then
            echo "HOSTS not set in config file"
            return 1
        fi
        if ! grep -e 'HOSTSD=' $configfile > /dev/null 2>&1; then
            echo "HOSTSD not set in config file"
            return 1
        fi
    fi
    echo "$configfile"
    return 0
}

load_configfile() {
    local configfile="$1"

    if [ "$configfile" = "" ]; then
        return 0
    fi

    local tmphosts=$(
        grep -e 'HOSTS=' $configfile \
            | cut -d '=' -f 2- \
            | sed -e "s/'\|\"//g"
    )
    local tmphostsfolder=$(dirname "$tmphosts")
    mkdir -p "$tmphostsfolder"
    tmphostsfolder=$(realpath $tmphostsfolder)
    tmphosts="$tmphostsfolder/$(basename "$tmphosts")"
    HOSTS="$tmphosts"
    local tmphostsd=$(
        grep -e 'HOSTSD=' $configfile \
            | cut -d '=' -f 2- \
            | sed -e "s/'\|\"//g"
    )
    tmphostsd=$(realpath $tmphostsd)
    if [ -d "$tmphostsd" ]; then
        HOSTSD="$tmphostsd"
    fi
}

hostsd_write() {
    echo "# AUTOMATICALLY GENERATED by hosts.d do not manually modify" \
        > "$HOSTS.new"
    for file in "$HOSTSD"/*.conf; do
        hostsd_format_out_hosts "$file" >> "$HOSTS.new"
    done
    mv "$HOSTS.new" "$HOSTS"
}

hostsd_format_out_hosts() {
    local file=$1

    IFS=$'\n'
    for line in $(cat "$file"); do
        echo "$line" | awk '{for (i=2; i<=NF; i++) print $1 " " $i}'
    done
}

run() {
    local configfile=''

    # getopts
    while true; do
        case "$1" in
            -h | --help )
                usage
                exit 1
                ;;
            -c | --config )
                if [ ! -z $2 ]; then
                    configfile=$2
                    shift
                fi
                shift
                ;;
            * ) shift ;;
        esac
        if [[ 0 -eq $# ]]; then
            break;
        fi
    done

    configfile=$(check_configfile $configfile)
    if [ "$?" -ne 0 ]; then
        echo "$configfile"
        exit 1
    fi
    load_configfile $configfile

    hostsd_write
}

run $@
